<!DOCTYPE html>
<html>
<head>
  <title>Blind Test</title>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="max-w-3xl mx-auto px-4 py-8">
    <div class="bg-white rounded-lg shadow-lg p-8">
      <h1 class="text-4xl font-bold text-center text-gray-800 mb-8">Blind Test</h1>

      <div class="text-3xl font-semibold text-center text-gray-700 my-6">
        <span id="track-placeholder">???</span>
      </div>

      <div id="player-container" class="hidden">
        <div class="w-full rounded-lg overflow-hidden shadow-md my-6">
          <iframe id="spotify-player"
                  class="w-full"
                  height="152"
                  frameborder="0"
                  allowtransparency="true"
                  allow="encrypted-media">
          </iframe>
        </div>
        <div class="text-xl text-center text-gray-600 mb-6">
          <span id="track-name"></span>
        </div>
      </div>

      <div class="flex justify-center space-x-4 my-8">
        <%= form_tag play_user_path(@user, id: @playlist.id), method: :post, class: "inline", id: "play-form" do %>
          <%= hidden_field_tag :track_id, "", id: "current-track-id" %>
          <%= button_tag "Play", type: "submit", class: "px-6 py-3 bg-green-500 text-white font-semibold rounded-full hover:bg-green-600 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50" %>
        <% end %>

        <button id="reveal-btn" onclick="revealTrack()"
                class="px-6 py-3 bg-blue-500 text-white font-semibold rounded-full hover:bg-blue-600 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
          Réponse
        </button>

        <%= form_tag next_track_user_path(@user, id: @playlist.id), method: :post, class: "inline", id: "next-form" do %>
          <%= hidden_field_tag :track_id, "", id: "next-track-id" %>
          <%= button_tag "Next", type: "submit", class: "px-6 py-3 bg-green-500 text-white font-semibold rounded-full hover:bg-green-600 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50" %>
        <% end %>
      </div>
    </div>
  </div>

  <script>
    // Récupération des tracks depuis le contrôleur
    const tracks = <%= raw @tracks.map { |track| { id: track.id, name: track.name, artists: track.artists.map(&:name).join(", ") } }.to_json %>;

    let currentTrackIndex = 0;
    const player = document.getElementById('spotify-player');
    const playerContainer = document.getElementById('player-container');
    const trackName = document.getElementById('track-name');
    const revealBtn = document.getElementById('reveal-btn');
    const currentTrackId = document.getElementById('current-track-id');
    const nextTrackId = document.getElementById('next-track-id');

    function updateTrackInfo() {
      const track = tracks[currentTrackIndex];
      currentTrackId.value = track.id;
      nextTrackId.value = track.id;
      player.src = `https://open.spotify.com/embed/track/${track.id}`;
      playerContainer.classList.add('hidden');
      revealBtn.textContent = 'Réponse';
    }

    function revealTrack() {
      const track = tracks[currentTrackIndex];
      if (playerContainer.classList.contains('hidden')) {
        playerContainer.classList.remove('hidden');
        trackName.textContent = `${track.name} - ${track.artists}`;
        revealBtn.textContent = 'Cacher';
      } else {
        playerContainer.classList.add('hidden');
        revealBtn.textContent = 'Réponse';
      }
    }

    // Initialisation
    updateTrackInfo();
  </script>
</body>
</html>
